<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Chess Visualizer</title>

<script src="/static/chess.js"></script>

<style>
body {
  background:#1e1e1e;
  color:white;
  font-family: monospace;
  margin:20px;
}

#container {
  display:flex;
  gap:20px;
}

#board {
  display:grid;
  grid-template-columns: repeat(8, 60px);
  border:2px solid #000;
}

.cell {
  width:60px;
  height:60px;
  text-align:center;
  line-height:60px;
  font-size:36px;
}

.white { background:#f0f0f0; color:black; }
.green { background:#76a86b; color:black; }

.highlight {
  box-shadow: inset 0 0 0 4px rgba(255,255,0,0.7);
}

#panel {
  width:260px;
}

#evalbar {
  width:20px;
  height:300px;
  background:#555;
  position:relative;
  margin-bottom:20px;
}

#evalfill {
  position:absolute;
  bottom:0;
  width:100%;
  background:black;
}

#moves {
  max-height:360px;
  overflow-y:auto;
  font-size:14px;
}

.move {
  padding:2px 4px;
}

.move.active {
  background:#444;
}

button {
  background:black;
  color:white;
  border:1px solid #aaa;
  padding:6px 10px;
  margin-top:6px;
  cursor:pointer;
}
</style>
</head>

<body>

<h2>Chess Visualizer</h2>

<div id="container">
  <div id="board"></div>

  <div id="panel">
    <div id="evalbar">
      <div id="evalfill"></div>
    </div>

    <div id="moves"></div>

    <button id="prev">◀ Prev</button>
    <button id="next">Next ▶</button>
    <br>
    <button onclick="location.href='/'">Back</button>
  </div>
</div>

<script>
const moves = {{ moves|tojson }};

const game = new Chess();
let cursor = 0;
let lastMove = null;

const pieceMap = {
  wp:"♙", wn:"♘", wb:"♗", wr:"♖", wq:"♕", wk:"♔",
  bp:"♟", bn:"♞", bb:"♝", br:"♜", bq:"♛", bk:"♚"
};

function drawBoard() {
  const boardDiv = document.getElementById("board");
  boardDiv.innerHTML = "";

  const pos = game.board();

  for (let r = 7; r >= 0; r--) {
    for (let f = 0; f < 8; f++) {
      const cell = document.createElement("div");
      const isWhite = (r + f) % 2 === 0;
      cell.className = "cell " + (isWhite ? "white" : "green");

      if (lastMove &&
          ((lastMove.from === r*8+f) || (lastMove.to === r*8+f))) {
        cell.classList.add("highlight");
      }

      const p = pos[r][f];
      if (p) cell.textContent = pieceMap[p.color + p.type];

      boardDiv.appendChild(cell);
    }
  }
}

function drawMoves() {
  const div = document.getElementById("moves");
  div.innerHTML = "";

  moves.forEach((m, i) => {
    const d = document.createElement("div");
    d.className = "move" + (i === cursor-1 ? " active" : "");
    d.textContent =
      (i%2===0 ? `${(i+2)/2}W. ` : `${(i+1)/2}B. `) +
      m.san + `  [${m.label}]`;
    div.appendChild(d);
  });
}

function drawEval() {
  const bar = document.getElementById("evalfill");
  if (cursor === 0) {
    bar.style.height = "50%";
    return;
  }
  const d = Math.max(-10, Math.min(10, moves[cursor-1].delta));
  bar.style.height = ((d + 10) / 20 * 100) + "%";
  bar.style.background = d >= 0 ? "black" : "white";
}

function nextMove() {
  if (cursor >= moves.length) return;
  const mv = game.move(moves[cursor].san);
  lastMove = { from: mv.from, to: mv.to };
  cursor++;
  drawBoard(); drawMoves(); drawEval();
}

function prevMove() {
  if (cursor <= 0) return;
  game.undo();
  cursor--;
  lastMove = null;
  drawBoard(); drawMoves(); drawEval();
}

document.getElementById("next").onclick = nextMove;
document.getElementById("prev").onclick = prevMove;

drawBoard();
drawMoves();
drawEval();
</script>

</body>
</html>

    if(cursor > 0) cursor--;
    updateBoard();
}

updateBoard();
</script>
</body>
</html>
