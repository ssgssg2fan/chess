<!DOCTYPE html>
<html>
<head>
    <title>Chess Visualizer</title>
    <style>
        body { font-family: monospace; margin:20px; }
        #container { display:flex; }
        #board { display:grid; grid-template-columns: repeat(8, 60px); grid-gap: 1px; }
        .cell { width:60px; height:60px; text-align:center; line-height:60px; font-size:36px; }
        .white { background-color:#eee; }
        .black { background-color:#888; color:white; }
        .highlight { background-color: yellow !important; }
        #panel { margin-left:20px; width:300px; }
        #moves { max-height:400px; overflow-y:auto; font-size:14px; }
        #evalbar { width:20px; height:300px; background:#ccc; margin:10px auto; position:relative; }
        #evalfill { width:100%; background:black; position:absolute; bottom:0; }
        .btn { margin:5px; padding:5px 10px; }
    </style>
</head>
<body>
    <h1>Chess Visualizer</h1>
    <div id="container">
        <div id="board"></div>
        <div id="panel">
            <div id="evalbar"><div id="evalfill"></div></div>
            <div id="moves"></div>
            <button class="btn" id="prev">◀ Prev</button>
            <button class="btn" id="next">Next ▶</button>
        </div>
    </div>

    <script>
        const moves = {{ moves|tojson }};
        const board = Array(8).fill(null).map(()=>Array(8).fill(''));
        const pieceSymbols = {
            'P':'♙','N':'♘','B':'♗','R':'♖','Q':'♕','K':'♔',
            'p':'♟','n':'♞','b':'♝','r':'♜','q':'♛','k':'♚'
        };

        let cursor = 0;
        let lastMove = null;

        function initBoard() {
            for(let r=0;r<8;r++){
                for(let f=0;f<8;f++){
                    board[r][f]='';
                }
            }
        }

        function drawBoard(){
            const boardDiv = document.getElementById('board');
            boardDiv.innerHTML='';
            for(let r=7;r>=0;r--){
                for(let f=0;f<8;f++){
                    const cell = document.createElement('div');
                    cell.className = 'cell ' + ((r+f)%2?'white':'black');
                    if(lastMove && (lastMove[0]==r*8+f || lastMove[1]==r*8+f)){
                        cell.classList.add('highlight');
                    }
                    cell.textContent = board[r][f];
                    boardDiv.appendChild(cell);
                }
            }
        }

        function drawMoves(){
            const movesDiv = document.getElementById('moves');
            movesDiv.innerHTML='';
            moves.forEach((m,i)=>{
                const div = document.createElement('div');
                div.textContent=`${m.turn} ${m.color}. ${m.san} [${m.label}] Δ=${m.delta}`;
                if(i===cursor-1) div.style.background='#ccc';
                movesDiv.appendChild(div);
            });
        }

        function drawEvalBar(){
            const bar = document.getElementById('evalfill');
            if(cursor===0){ bar.style.height='50%'; return; }
            const m = moves[cursor-1];
            const val = Math.max(-1,Math.min(1,m.delta/20));
            bar.style.height = ((val+1)/2*100) + '%';
            bar.style.backgroundColor = val>=0?'black':'white';
        }

        function pushMove(){
            if(cursor>=moves.length) return;
            const m = moves[cursor];
            // 간단한 FEN 파서 없이 그냥 SAN 텍스트 표시
            const pieceChar = m.san[0];
            const color = m.color==='W'?pieceChar.toUpperCase():pieceChar.toLowerCase();
            board[7][0]=pieceSymbols[color]||pieceSymbols['P']; // 임시 위치 표시
            lastMove=[0,7]; // 임시
            cursor++;
            drawBoard(); drawMoves(); drawEvalBar();
        }

        function popMove(){
            if(cursor<=0) return;
            cursor--;
            lastMove=null;
            drawBoard(); drawMoves(); drawEvalBar();
        }

        document.getElementById('next').onclick = pushMove;
        document.getElementById('prev').onclick = popMove;

        initBoard();
        drawBoard();
        drawMoves();
        drawEvalBar();
    </script>
</body>
</html>
